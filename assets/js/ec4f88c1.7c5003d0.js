"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[3601],{28453:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>l});var s=t(96540);const i={},r=s.createContext(i);function o(e){const n=s.useContext(r);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),s.createElement(r.Provider,{value:n},e.children)}},62295:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>d,contentTitle:()=>l,default:()=>h,frontMatter:()=>o,metadata:()=>s,toc:()=>a});const s=JSON.parse('{"id":"prelude/rules/core/genrule","title":"genrule","description":"genrule","source":"@site/../docs/prelude/rules/core/genrule.md","sourceDirName":"prelude/rules/core","slug":"/prelude/rules/core/genrule","permalink":"/docs/prelude/rules/core/genrule","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"ruleSidebar","previous":{"title":"filegroup","permalink":"/docs/prelude/rules/core/filegroup"},"next":{"title":"http_archive","permalink":"/docs/prelude/rules/core/http_archive"}}');var i=t(74848),r=t(28453);t(56289);const o={},l="genrule",d={},a=[{value:"genrule",id:"genrule-1",level:2},{value:"Parameters",id:"parameters",level:4},{value:"Details",id:"details",level:4}];function c(e){const n={code:"code",em:"em",h1:"h1",h2:"h2",h4:"h4",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"genrule",children:"genrule"})}),"\n",(0,i.jsx)(n.h2,{id:"genrule-1",children:"genrule"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'def genrule(\n    *,\n    name: str,\n    default_target_platform: None | str = None,\n    target_compatible_with: list[str] = [],\n    compatible_with: list[str] = [],\n    exec_compatible_with: list[str] = [],\n    visibility: list[str] = [],\n    within_view: list[str] = ["PUBLIC"],\n    metadata: OpaqueMetadata = {},\n    tests: list[str] = [],\n    modifiers: OpaqueMetadata = [],\n    _apple_platforms: dict[str, str] = {},\n    _build_only_native_code: bool = select({"prelude//android/constraints:build_only_native_code": True, "DEFAULT": False}),\n    _exec_os_type: str = "prelude//os_lookup/targets:os_lookup",\n    _genrule_toolchain: str = "gh_facebook_buck2_shims_meta//:genrule",\n    always_print_stderr: bool = False,\n    bash: None | str = None,\n    cacheable: None | bool = None,\n    cmd: None | str = None,\n    cmd_exe: None | str = None,\n    constraint_overrides: list[None | str] = [],\n    contacts: list[str] = [],\n    default_host_platform: None | str = None,\n    default_outs: None | list[str] = None,\n    enable_sandbox: None | bool = None,\n    env: dict[str, str] = {},\n    environment_expansion_separator: None | str = None,\n    executable: None | bool = None,\n    executable_outs: None | list[str] = None,\n    labels: list[str] = [],\n    licenses: list[str] = [],\n    metadata_env_var: None | str = None,\n    metadata_path: None | str = None,\n    need_android_tools: bool = False,\n    no_outputs_cleanup: bool = False,\n    out: None | str = None,\n    outs: None | dict[str, list[str]] = None,\n    platform_override: None | str = None,\n    remote: None | bool = None,\n    remote_execution_dependencies: list[dict[str, str]] = [],\n    srcs: list[str] | dict[str, str] = [],\n    type: None | str = None,\n    uses_experimental_content_based_path_hashing: bool = False,\n    weight: None | int = None,\n) -> None\n'})}),"\n",(0,i.jsxs)(n.p,{children:["A ",(0,i.jsx)(n.code,{children:"genrule()"})," is used to generate files from a shell command. It must produce a single output file or folder."]}),"\n",(0,i.jsx)(n.h4,{id:"parameters",children:"Parameters"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"name"}),": name of the target"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"default_target_platform"}),": specifies the default target platform, used when no platforms are specified on the command line"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"target_compatible_with"}),": a list of constraints that are required to be satisfied for this target to be compatible with a configuration"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"compatible_with"}),": a list of constraints that are required to be satisfied for this target to be compatible with a configuration"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"exec_compatible_with"}),": a list of constraints that are required to be satisfied for this target to be compatible with an execution platform"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"visibility"}),": a list of visibility patterns restricting what targets can depend on this one"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"within_view"}),": a list of visibility patterns restricting what this target can depend on"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"metadata"}),": a key-value map of metadata associated with this target"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"tests"}),": a list of targets that provide tests for this one"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"modifiers"}),": an array of modifiers associated with this target"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"bash"}),": A platform-specific version of the shell command parameter ",(0,i.jsx)(n.code,{children:"cmd"}),". It runs on Linux and UNIX systems\u2014including OSX\u2014on which ",(0,i.jsx)(n.code,{children:"bash"})," is installed. It has a higher priority than ",(0,i.jsx)(n.code,{children:"cmd"}),". The ",(0,i.jsx)(n.code,{children:"bash"})," argument is run with ",(0,i.jsx)(n.code,{children:"/usr/bin/env bash -c"}),". It has access to the same set of macros and variables as the ",(0,i.jsx)(n.code,{children:"cmd"})," argument."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"cmd"}),": The shell command to run to generate the output file. It is the fallback for ",(0,i.jsx)(n.code,{children:"bash"})," and ",(0,i.jsx)(n.code,{children:"cmd_exe"})," arguments. The following environment variables are populated by Buck and available to the shell command. They are accessed using the syntax:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"${<variable>}\n"})}),"\n",(0,i.jsx)(n.p,{children:"Example:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"${SRCS}\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.code,{children:"${SRCS}"})}),"\n",(0,i.jsxs)(n.p,{children:["A string expansion of the ",(0,i.jsx)(n.code,{children:"srcs"})," argument delimited\nby the ",(0,i.jsx)(n.code,{children:"environment_expansion_separator"})," argument\nwhere each element of ",(0,i.jsx)(n.code,{children:"srcs"})," will be translated\ninto a relative path."]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.code,{children:"${SRCDIR}"})}),"\n",(0,i.jsx)(n.p,{children:"The relative path to a directory to which sources are copied\nprior to running the command."}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.code,{children:"${OUT}"})}),"\n",(0,i.jsxs)(n.p,{children:["The output file or directory for the ",(0,i.jsx)(n.code,{children:"genrule()"}),".\nThis variable will have whatever value is specified by\nthe ",(0,i.jsx)(n.code,{children:"out"})," argument if not using named outputs. If\nusing named outputs, this variable will be the output directory."]}),"\n",(0,i.jsx)(n.p,{children:"The value should be a valid filepath. The semantics of the shell\ncommand determine whether this filepath is treated as a file or a\ndirectory. If the filepath is a directory, then the shell command\nneeds to create it if not using named outputs. Otherwise, it will\nbe automatically created. All outputs (directories and files) must\nbe readable, writable, and (in the case of directories) executable\nby the current user."}),"\n",(0,i.jsx)(n.p,{children:"The file or directory specified by this variable must always\nbe written by this command. If not, the execution of this\nrule will be considered a failure, halting the build process."}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.code,{children:"${TMP}"})}),"\n",(0,i.jsx)(n.p,{children:"A temporary directory which can be used for intermediate\nresults and will not be bundled into the output."}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"cmd_exe"}),": A platform-specific version of the shell command parameter ",(0,i.jsx)(n.code,{children:"cmd"}),". It runs on Windows and has a higher priority than ",(0,i.jsx)(n.code,{children:"cmd"}),". The ",(0,i.jsx)(n.code,{children:"cmd_exe"})," argument is run with ",(0,i.jsx)(n.code,{children:"cmd.exe /v:off /c"}),". It has access to the same set of macros and variables as the ",(0,i.jsx)(n.code,{children:"cmd"})," argument."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"default_outs"}),": Default output which must be present if the ",(0,i.jsx)(n.code,{children:"outs"})," arg is present. Otherwise does not apply."]}),"\n",(0,i.jsxs)(n.p,{children:["If a rule with ",(0,i.jsx)(n.code,{children:"outs"})," is consumed without an output label, the default output is returned. The\ndefault output does not need to be present in any of the named outputs defined in ",(0,i.jsx)(n.code,{children:"outs"}),"."]}),"\n",(0,i.jsx)(n.p,{children:"Note that a maximum of one value may be present in this list. For example:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:'default_outs = [ "output_one", ]\n'})}),"\n",(0,i.jsx)(n.p,{children:"is valid, whereas"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:'default_outs = [ "output_one", "output_two", ]\n'})}),"\n",(0,i.jsx)(n.p,{children:"is not."}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"enable_sandbox"}),": Whether this target should be executed in a sandbox or not."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"env"}),": A map of variables to be set in the environment where the shell command is run."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"environment_expansion_separator"}),": The delimiter between paths in environment variables, such as SRCS, that can contain multiple paths. It can be useful to specify this parameter if the paths could contain spaces."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"executable"}),": Whether the output of the genrule is itself executable. Marking an output as executable makes ",(0,i.jsx)(n.code,{children:"buck run"})," and ",(0,i.jsx)(n.code,{children:"$(exe ...)"})," macro expansion work with this target."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"executable_outs"}),": Only valid if the ",(0,i.jsx)(n.code,{children:"outs"})," arg is present. Dictates which of those named outputs are marked as executable."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"out"}),": The name of the output file or directory. The complete path to this argument is provided to the shell command through the ",(0,i.jsx)(n.code,{children:"OUT"})," environment variable. Only one of ",(0,i.jsx)(n.code,{children:"out"})," or ",(0,i.jsx)(n.code,{children:"outs"})," may be present."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"outs"}),": Mapping defining ",(0,i.jsx)(n.code,{children:"named outputs"})," to output paths relative to the rule's output directory. Only one of ",(0,i.jsx)(n.code,{children:"out"})," or ",(0,i.jsx)(n.code,{children:"outs"})," may be present."]}),"\n",(0,i.jsx)(n.p,{children:"Example:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:'\ngenrule(\n  name = "named_outputs",\n  outs = {\n    "output1": [\n      "out1.txt",\n    ],\n    "output2": [\n      "out2.txt",\n    ],\n  },\n  default_outs = [ "out1.txt" ],\n  cmd = "echo something> $OUT/out1.txt && echo another> $OUT/out2.txt",\n)\n\n'})}),"\n",(0,i.jsx)(n.p,{children:"Note that a maximum of one value may be present in the list in this map. For example:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:'\nouts = {\n  "output1": [\n    "out1.txt",\n  ],\n},\n\n'})}),"\n",(0,i.jsx)(n.p,{children:"is valid, whereas"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:'\nouts = {\n  "output1": [\n    "out1.txt",\n    "out2.txt",\n  ],\n},\n\n'})}),"\n",(0,i.jsx)(n.p,{children:"is not."}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"remote"}),": Opts this genrule in to remote execution. Note that it is only safe to execute a genrule remotely if it is completely hermetic and completely and correctly describes its dependencies. Defaults to false. This parameter is unstable. It is subject to removal, default reversal, and other arbitrary changes in the future."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"srcs"}),": Either a list or a map of the source files which Buck makes available to the shell command at the path in the ",(0,i.jsx)(n.code,{children:"SRCDIR"})," environment variable. If you specify a list, the source files are the names in the list. If you specify a map, the source files are made available as the names in the keys of the map, where the values of the map are the original source file names."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"type"}),": Specifies the ",(0,i.jsx)(n.em,{children:"type"}),' of this genrule. This is used for logging and is particularly useful for grouping genrules that share an underlying logical "type".']}),"\n",(0,i.jsxs)(n.p,{children:["For example, if you have the following ",(0,i.jsx)(n.code,{children:"cxx_genrule"})," defined\nin the root directory of your Buck project"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"\n\ncxx_genrule(\n  name = 'cxx_gen',\n  type = 'epilog',\n  cmd  = 'touch finish.txt; cp finish.txt $OUT',\n  out  = 'finish.txt'\n)\n\n"})}),"\n",(0,i.jsxs)(n.p,{children:["then the following ",(0,i.jsx)(n.code,{children:"buck query"})," command"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"\n\nbuck query \"attrfilter( type, 'epilog', '//...' )\"\n\n"})}),"\n",(0,i.jsx)(n.p,{children:"returns"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"\n\n//:cxx_gen\n\n"})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"weight"}),": How many local slots these genrule should take when executing locally."]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h4,{id:"details",children:"Details"}),"\n",(0,i.jsx)(n.p,{children:"Examples:"}),"\n",(0,i.jsxs)(n.p,{children:["This genrule() uses a Python script to derive a new\n",(0,i.jsx)(n.code,{children:"AndroidManifest.xml"})," from an\n",(0,i.jsx)(n.code,{children:"AndroidManifest.xml"})," in the source tree.\nNote you don't need to prepend execution commands with\n",(0,i.jsx)(n.code,{children:"python"}),": Buck knows how to execute different\nkinds of binaries using ",(0,i.jsx)(n.code,{children:"$(exe)"})," command."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"\ngenrule(\n  name = 'generate_manifest',\n  srcs = [\n    'AndroidManifest.xml',\n  ],\n  bash = '$(exe //python/android:basic_to_full) '               '$SRCDIR/AndroidManifest.xml > $OUT',\n  cmd_exe = '$(exe //python/android:basic_to_full) '               '%SRCDIR%\\AndroidManifest.xml > %OUT%',\n  out = 'AndroidManifest.xml',\n)\n\n"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"\ngenrule(\n  name = 'generate_manifest_with_named_outputs',\n  srcs = [\n    'AndroidManifest.xml',\n  ],\n  bash = '$(exe //python/android:basic_to_full) '               '$SRCDIR/AndroidManifest.xml > $OUT/AndroidManifest.xml',\n  cmd_exe = '$(exe //python/android:basic_to_full) '               '%SRCDIR%\\AndroidManifest.xml > %OUT%\\AndroidManifest.xml',\n  outs =  {\n    \"manifest\": [ \"AndroidManifest.xml\" ],\n  },\n  default_outs = [ \"AndroidManifest.xml\" ],\n)\n\n"})}),"\n",(0,i.jsx)(n.p,{children:"For named outputs, build with any of the following:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"\n  buck build //:generate_manifest_with_named_outputs\n\n"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"\n  buck build //:generate_manifest_with_named_outputs[manifest]\n\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Consume in ",(0,i.jsx)(n.code,{children:"srcs"})," with:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:'\nexport_file(\n    name = "magic1",\n    src = ":generate_manifest_with_named_outputs",\n    out = "some_dir_to_copy_to/AndroidManifest.xml",\n)\n\n'})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:'\nexport_file(\n    name = "magic2",\n    src = ":generate_manifest_with_named_outputs[manifest]",\n    out = "some_dir_to_copy_to/AndroidManifest.xml",\n)\n\n'})}),"\n",(0,i.jsxs)(n.p,{children:["Note that ",(0,i.jsx)(n.code,{children:"magic1"})," consumes ",(0,i.jsx)(n.code,{children:"generate_manifest_with_named_outputs"}),"'s default\noutput. ",(0,i.jsx)(n.code,{children:"magic2"})," consumes ",(0,i.jsx)(n.code,{children:"generate_manifest_with_named_outputs"}),'\'s named\noutput "manifest," which happen to be pointing to the same output as the default output in this\ncase, but they do not have to point to the same output.']})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}}}]);